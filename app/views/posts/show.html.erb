<div class="grid gap-1">
  <div class="p-4">
    <div class="h-full border-2 border-gray-200 border-opacity-60 rounded-lg overflow-hidden">
      <% if @post.images.attached? %>
        <% @post.images.each do |image| %>
          <%= image_tag image, class: "w-full object-cover object-center" %>
        <% end %>
      <% else %>
        <img class="w-full object-cover object-center" src="https://dummyimage.com/720x400" alt="blog">
      <% end %>
      <div class="p-6">
        <h2 class="tracking-widest text-xs title-font font-medium text-gray-400 mb-1"><%= link_to @post.user.name, user_page_path(@post.user) %></h2>
        <h1 class="title-font text-lg font-medium text-gray-900 mb-3"><%= @post.title %></h1>
        <p class="leading-relaxed mb-3"><%= @post.content %></p>
          <p><%= how_long_ago(@post) %></p>
        <div class="flex items-center flex-wrap ">
          <span class="text-gray-400 mr-3 inline-flex items-center lg:ml-auto md:ml-0 ml-auto leading-none text-sm pr-3 py-1 border-r-2 border-gray-200">
            <svg class="w-4 h-4 mr-1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>1.2K
          </span>
          <span class="text-gray-400 inline-flex items-center leading-none text-sm">
            <svg class="w-4 h-4 mr-1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"></path>
            </svg>6
          </span>
        </div>
      </div>
    </div>
  </div>
  <% if user_signed_in? %>
    <% if current_user == @post.user %>
      <%= link_to '編集する', edit_post_path(@post) %> 
      <%= link_to "削除", @post, data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" } %>
    <% end %>
  <% end %>

  <% if user_signed_in? %>
    <%= form_with model: [@post, @comment] do |f| %>
      <%= f.text_area :context, placeholder: "コメントを入力..." %>
      <%= f.submit "SEND" %>
    <% end %>
  <% end %>
  <h3>コメント一覧</h3>
  <% if @comments.present? %>
    <% @comments.each do |c| %>  
      <% if c.reply_comment_id.present? %>
        <% next %>
      <% end %>
        <span id="comment_<%= c.id %>">
          <%= link_to mypage_path(c.user.id), class: "text-dark" do %> 
            <%if c.user.avatar.attached? %>
              <%= image_tag c.user.avatar, size: "200×200", class: "avatar" %>
            <% else %>
              <%= image_tag "no_avatar.png", size: "200×200", class: "avatar" %>
            <% end %>
            <strong><%= c.user.name %></strong>
          <% end %>
          <%= c.context %>
          <p><%= how_long_ago(c) %></p>
          <% if user_signed_in? && current_user == c.user %>
            <%= link_to "編集", edit_post_comment_path(@post, c) %>
            <%= link_to "削除", post_comment_path(@post, c), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" } %>
          <% end %>

          <div class="row mt-1">
            <div class="col-sm-8">
              <%= form_with model: [@post, @comment] do |f| %>
                <%= f.text_field :context, class: "rounded-pill form-control", placeholder: "コメントへの返信を入力..." %>
                <%= f.hidden_field :reply_comment_id, :value => c.id  %>
                <%= f.submit "返信", class: "btn" %>
              <% end %>
            </div>
          </div>

          <% if c.replies.present? %>
            <div class="ml-5">
              <% c.replies.each do |reply| %>
                <%if c.user.avatar.attached? %>
                  <%= image_tag c.user.avatar, size: "50×50", class: "avatar" %>
                <% else %>
                  <%= image_tag "no_avatar.png", size: "200×200", class: "avatar" %>
                <% end %>
                <%= reply.user.name %>
                <%= reply.context %>
                <p><%= how_long_ago(reply) %></p>
                <% if user_signed_in? && current_user == reply.user %>
                  <%= link_to "編集", edit_post_comment_path(@post, reply) %>
                  <%= link_to "削除", post_comment_path(@post, reply), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" } %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </span><br/>
    <% end %>
  <% else %>
    <p>まだコメントがありません</p>
  <% end %>
  <%= link_to '一覧に戻る', posts_path, class:"no-tap-highlighting" %>
</div>
